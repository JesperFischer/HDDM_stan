---
title: "HDD"
output: html_document
date: "2023-09-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse,RWiener, tidybayes, posterior, furrr)

```

## R Markdown



```{r}
library(cmdstanr)

mod <- cmdstan_model(here::here("HDMM_rng.stan"))

out <- mod$sample(
  data = list(
    N = 400,
    alpha_in = 1.25,
    tau_in = 0.2,
    beta_in = 0.7,
    delta_in = -0.3
  ),
  parallel_chains = 4
)

out$summary()
```

```{r}
trials = 500
alpha = 2
delta = 0
beta = 0.5
tau = 0.1


parameters = data.frame(alpha,delta,beta,tau, trials)

data = rwiener(n = trials,
        alpha = alpha,
        delta = delta,
        beta = beta,
        tau = tau)

data_stan = list(Nu = nrow(data %>% filter(resp == "upper")),
                 Nl = nrow(data %>% filter(resp == "lower")),
                 RTu = data %>% filter(resp == "upper") %>% .$q,
                 RTl = data %>% filter(resp == "lower") %>% .$q,
                 minRT = min(data$q),
                 run_estimation = 1)


mod = cmdstanr::cmdstan_model(here::here("HDDM.stan"))


fit <- mod$sample(
    data = data_stan,
    chains = 4,
    parallel_chains = 4,
    adapt_delta = 0.9,
    max_treedepth = 12)




rt_pattern <- "out\\[\\d+,1\\]"
choice_pattern <- "out\\[\\d+,2\\]"


Rts = fit$summary() %>%
  filter(grepl(rt_pattern, variable))


Rts = as_draws_df(fit$draws()) %>%
  select(matches(rt_pattern))

Rts %>% slice(sample(1:4000,10)) %>% pivot_longer(everything()) %>% ggplot(aes(x = value))+geom_histogram()

choice = fit$summary() %>%
  filter(grepl(choice_pattern, variable))

choice = as_draws_df(fit$draws()) %>%
  select(matches(choice_pattern))


posteriors = as_draws_df(fit) %>% dplyr::select(any_of(names(parameters))) %>% mutate(prior = F)
priors = as_draws_df(fit) %>% dplyr::select(starts_with("prior_")) %>% rename_with(~gsub("^prior_", "", .), everything()) %>% mutate(prior = T)

rbind(posteriors,priors) %>% 
  pivot_longer(cols = -prior) %>% 
  ggplot(aes(x = value, fill = prior))+
  geom_density(alpha = 0.5)+
  theme_classic()+
  facet_wrap(~name, scales = "free")+
  geom_vline(data = parameters %>% select(-trials) %>% pivot_longer(everything()), aes(xintercept = value))


draws = 10
#pp_check
as_draws_df(fit$draws()) %>%
  select(matches(rt_pattern)) %>% slice(sample(1:4000,draws)) %>% 
  pivot_longer(everything()) %>% mutate(estimated = TRUE, slice = rep(1:trials,draws)) %>% 
  ggplot()+
  geom_density(aes(x = value, group = slice), color = "lightblue")+
  geom_density(data = data %>% mutate(estimated = FALSE), aes(x = q), color = "red")+
  theme_classic()




```

## fit model
```{r}

seed = 1234
trials = 50
alpha = 2
delta = 0.5
beta = 0.2
tau = 0.3

parameters = data.frame(alpha,delta,beta,tau, trials)

fit_model = function(parameters){
  id = parameters$id
  
  data = rwiener(n = parameters$trials,
          alpha = parameters$alpha,
          delta = parameters$delta,
          beta = parameters$beta,
          tau = parameters$tau)
  
  data_stan = list(Nu = nrow(data %>% filter(resp == "upper")),
                   Nl = nrow(data %>% filter(resp == "lower")),
                   RTu = data %>% filter(resp == "upper") %>% .$q,
                   RTl = data %>% filter(resp == "lower") %>% .$q,
                   minRT = 0.5,
                   RTbound = 0)
  
  
  mod = cmdstanr::cmdstan_model(here::here("HDDM.stan"))
  
  
  fit <- mod$sample(
      data = data_stan,
      seed = seed,
      chains = 4,
      parallel_chains = 4,
      adapt_delta = 0.9,
      max_treedepth = 12)
  
  
  
  posteriors = as_draws_df(fit$summary()) %>% dplyr::filter(variable %in% names(parameters))
  diag = data.frame(fit$diagnostic_summary(), id)
  
  data = posteriors %>% mutate(num_div = diag$num_divergent,
                               tree_depth = diag$num_max_treedepth,
                               real_alpha = parameters$alpha,
                               real_delta = parameters$delta,
                               real_beta = parameters$beta,
                               real_tau = parameters$tau,
                               trials = parameters$trials,
                               id = id) %>% select(-contains("."))
  return(list(data, diag))
}
```

```{r}
trials = seq(10,100,by = 10)
alpha = seq(0,5,by = 1)
delta = seq(-4,4,by = 1)
beta = seq(0.1,0.9,by = 0.1)
tau = seq(0.1,0.4,by = 0.1)

parameters = expand.grid(alpha = alpha,delta = delta,beta = beta,tau = tau, trials = trials) %>% 
  mutate(id = 1:nrow(.))

data_list <- split(parameters, parameters$id)
```


```{r}
#cores = availableCores()-1

plan(multisession, workers = cores)

possfit_model = possibly(.f = fit_model, otherwise = "Error")

results <- future_map(data_list, ~possfit_model(.x), .progress = TRUE, .options = furrr_options(seed = TRUE))

error_indices <- which(results == "Error")

unique(error_indices)

results2 = results[results != "Error"]
```

lets look at the divergences
```{r}
results2[[2]]

divergence = map_dfr(results2, 2)

divergence %>% median_qi(num_divergent)
```
there are none which is good now at the parameter values

```{r, fig.height=10, fig.width=10}
params = map_dfr(results2, 1)

params %>% filter(variable == "alpha") %>% 
  ggplot(aes(x = mean, fill = as.factor(real_alpha)))+
  geom_density(alpha = 0.5)+
  theme_classic()+
  geom_vline(aes(xintercept = real_alpha))+
  facet_wrap(~trials)

```







```{r real data}

data = read.csv(here::here("~","Thermal-Pain-Learning","Analysis","Cleaned-data","TPL_df.csv"))

trajfeel2 = read.csv(here::here("~","Thermal-Pain-Learning","Analysis","Computational_modeling","trajectories","binary_response_feel_2_v2.csv"), header = F)
data$stim = as.factor(data$stim)
data$id = as.factor(data$id)

data$stim = relevel(data$stim, ref = "cold")

data1 = data %>% filter(id %in% trajfeel2$V33)
traj1 = trajfeel2 %>% filter(V33 %in% data$id)
traj1[,34] = rep(1:306,length(unique(traj1$V33)))


traj1 = traj1 %>% dplyr::rename(mu1 = V1, mu2 = V2, 
                                mu3 = V3, sa1 = V4, 
                                sa2 = V5, sa3 = V6, 
                                mu1hat = V7, mu2hat = V8, 
                                mu3hat = V9, sa1hat = V10, 
                                sa2hat = V11, sa3hat = V12, 
                                weight_v_1 = V13, weight_v_2 = V14, 
                                weight_v_3 = V15, weight_w_1 = V16, 
                                weight_w_2 = V17, volatility_pe1 = V18, 
                                volatility_pe2 = V19, volatility_pe3 = V20, 
                                update_ud_1 = V21, update_ud_2 = V22, 
                                update_ud_3 = V23, pweights_on_pe1 = V24, 
                                pweights_on_pe2 = V25, pweights_on_pe3 = V26, 
                                pwpe1 = V27, pwpe2 = V28, pwpe3 = V29, 
                                learn_rate1 = V30, learn_rate2 = V31, 
                                learn_rate3 = V32, id = V33, 
                                trial = V34)

traj1$id = as.factor(traj1$id)
df = inner_join(data1,traj1, by = c("id","trial"))

df$burnbeta = df$vasResp_3/100
df$coldbeta = df$vasResp_1/100
df$warmbeta = df$vasResp_2/100





df$u = ifelse(df$cue == "low-tone" & df$stim == "TGI", a <- 1-(df$vasResp_1/(df$vasResp_1+df$vasResp_2)),
              ifelse(df$cue == "high-tone" & df$stim == "TGI", a <- (df$vasResp_1/(df$vasResp_1+df$vasResp_2)),
                     ifelse(df$cue == "low-tone" & df$stim == "cold", a <- 0, 
                            ifelse(df$cue == "high-tone" & df$stim == "warm", a <- 0,
                                   ifelse(df$cue == "low-tone" & df$stim == "warm", a <- 1,
                                          ifelse(df$cue == "high-tone" & df$stim == "cold", a <- 1, a <- 0.1))))))

df$predResp2 = ifelse(df$cue == "low-tone" & df$predResp == "cold", a <- 0, 
                      ifelse(df$cue == "high-tone" & df$predResp == "warm", a <- 0,
                             ifelse(df$cue == "low-tone" & df$predResp == "warm", a <- 1,
                                    ifelse(df$cue == "high-tone" & df$predResp == "cold", a <- 1, a <- NaN))))

df1 = df

df = df1 %>% filter(id == 265)
write.csv(df, here::here("df.csv"))
df = df %>% dplyr::select(u,predRT,predResp2, mu1hat, trial,desired_prob)

df = na.omit(df)

df %>% ggplot(aes(x = trial, y = mu1hat))+geom_line()+geom_point(aes(x = trial, y = u))+geom_line(aes(x = trial, y = desired_prob), col = "red")+theme_classic()



data_stan = list(Nu = nrow(df %>% filter(u == 1)),
                 Nl = nrow(df %>% filter(u == 0)),
                 RTu = df %>% filter(u == 1) %>% .$predRT,
                 RTl = df %>% filter(u == 0) %>% .$predRT,
                 minRT = min(df$predRT),
                 run_estimation = 1,
                 trials = nrow(df),
                 u = df$u,
                 indexupper = df %>% filter(u == 1) %>% .$trial,
                 indexlower = df %>% filter(u == 0) %>% .$trial,
                 resp = c(df$predResp2,0))




mod = cmdstanr::cmdstan_model(here::here("RLDDM.stan"))


fit <- mod$sample(
    data = data_stan,
    chains = 4,
    iter_warmup = 500,
    iter_sampling = 500,
    parallel_chains = 4,
    adapt_delta = 0.8,
    max_treedepth = 8)


expectations = fit$summary() %>% filter(grepl("expect\\[\\d+\\]", variable))
expectations %>% ggplot(aes(x = 1:306, y = mean))+geom_line()


```

